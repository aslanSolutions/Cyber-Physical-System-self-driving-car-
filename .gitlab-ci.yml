image: docker:latest
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_CLI_EXPERIMENTAL: enabled
  DOCKER_BUILDKIT: 1
services:
  docker:dind
  
stages:
  build
  deploy
  
before_script:
  docker info
  docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY_URL
  docker buildx create --name mybuilder --use

build-and-test:
  tags:
    docker-build
  stage: build
  script:
    echo "Building with Buildx..."
    docker buildx build --platform "linux/amd64,linux/arm/v7" -f Dockerfile -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" --push .
  except:
    tags
release:
  tags:
    docker-build
  stage: deploy
  script:
    echo "Deploying to Registry..."
    docker buildx build --platform "linux/amd64,linux/arm/v7" -f Dockerfile -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" --push .
  only:
    /^v\d+.\d+.\d+$/
